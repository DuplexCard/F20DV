<meta charset="utf-8">

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v7.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>


<!-- Create an element where the map will take place -->
<svg id="my_dataviz" width="500" height="500" ></svg>
<script>

    // The svg
    const svg = d3.select("svg"),
      width = +svg.attr("width"),
      height = +svg.attr("height");
    
    // Map and projection
    const path = d3.geoPath();
    const projection = d3.geoNaturalEarth1()
    .scale(width / 1.3 / Math.PI)
    .translate([width / 2, height / 2])
    
    // Data and color scale
    const data = new Map();
    const colorScale = d3.scaleThreshold()
      .domain([100000, 1000000, 10000000, 30000000, 100000000, 500000000])
      .range(d3.schemeBlues[7]);
    
      d3.csv(
    "https://raw.githubusercontent.com/owid/covid-19-data/master/public/data/owid-covid-data.csv",
    function (d) {
      return {
        iso_code: d.iso_code,
        continent: d.continent,
        location: d.iso_code,
        date: d.date,
        total_cases: +d.total_cases,
        new_cases: +d.new_cases,
        new_cases_smoothed: +d.new_cases_smoothed,
        total_deaths: +d.total_deaths,
        new_deaths: +d.new_deaths,
        new_deaths_smoothed: +d.new_deaths_smoothed,
        total_cases_per_million: +d.total_cases_per_million,
        new_cases_per_million: +d.new_cases_per_million,
        new_cases_smoothed_per_million: +d.new_cases_smoothed_per_million,
        total_deaths_per_million: +d.total_deaths_per_million,
        new_deaths_per_million: +d.new_deaths_per_million,
        new_deaths_smoothed_per_million: +d.new_deaths_smoothed_per_million,
        reproduction_rate: +d.reproduction_rate,
        icu_patients: +d.icu_patients,
        icu_patients_per_million: +d.icu_patients_per_million,
        hosp_patients: +d.hosp_patients,
        hosp_patients_per_million: +d.hosp_patients_per_million,
        weekly_icu_admissions: +d.weekly_icu_admissions,
        weekly_icu_admissions_per_million: +d.weekly_icu_admissions_per_million,
        weekly_hosp_admissions: +d.weekly_hosp_admissions,
        weekly_hosp_admissions_per_million: +d.weekly_hosp_admissions_per_million,
        total_tests: +d.total_tests,
        new_tests: +d.new_tests,
        total_tests_per_thousand: +d.total_tests_per_thousand,
        new_tests_per_thousand: +d.new_tests_per_thousand,
        new_tests_smoothed: +d.new_tests_smoothed,
        new_tests_smoothed_per_thousand: +d.new_tests_smoothed_per_thousand,
        positive_rate: +d.positive_rate,
        tests_per_case: +d.tests_per_case,
        tests_units: +d.tests_units,
        total_vaccinations: +d.total_vaccinations,
        people_vaccinated: +d.people_vaccinated,
        people_fully_vaccinated: +d.people_fully_vaccinated,
        total_boosters: +d.total_boosters,
        new_vaccinations: +d.new_vaccinations,
        new_vaccinations_smoothed: +d.new_vaccinations_smoothed,
        total_vaccinations_per_hundred: +d.total_vaccinations_per_hundred,
        people_vaccinated_per_hundred: +d.people_vaccinated_per_hundred,
        people_fully_vaccinated_per_hundred: +d.people_fully_vaccinated_per_hundred,
        total_boosters_per_hundred: +d.total_boosters_per_hundred,
        new_vaccinations_smoothed_per_million: +d.new_vaccinations_smoothed_per_million,
        new_people_vaccinated_smoothed: +d.new_people_vaccinated_smoothed,
        new_people_vaccinated_smoothed_per_hundred: +d.new_people_vaccinated_smoothed_per_hundred,
        stringency_index: +d.stringency_index,
        population_density: +d.population_density,
        median_age: +d.median_age,
        aged_65_older: +d.aged_65_older,
        aged_70_older: +d.aged_70_older,
        gdp_per_capita: +d.gdp_per_capita,
        extreme_poverty: +d.extreme_poverty,
        cardiovasc_death_rate: +d.cardiovasc_death_rate,
        diabetes_prevalence: +d.diabetes_prevalence,
        female_smokers: +d.female_smokers,
        male_smokers: +d.male_smokers,
        handwashing_facilities: +d.handwashing_facilities,
        hospital_beds_per_thousand: +d.hospital_beds_per_thousand,
        life_expectancy: +d.life_expectancy,
        human_development_index: +d.human_development_index,
        population: +d.population,
        excess_mortality_cumulative_absolute: +d.excess_mortality_cumulative_absolute,
        excess_mortality_cumulative: +d.excess_mortality_cumulative,
        excess_mortality: +d.excess_mortality,
        excess_mortality_cumulative_per_million: +d.excess_mortality_cumulative_per_million

      };
    }).then(function(data) {
       nestedData = d3.group(data, d => d.date, d => d.location);
    


    // Load external data and boot
    d3.json("https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson")
   .then(function(topo){

      
      console.log(data[45345])
      const date = "2022-01-06";
      const location2 = "QAT";
      const totalDeaths = nestedData.get(date).get(location2)[0].total_cases;
      const totalDeaths2 = nestedData.get(date)
    /*  totalDeaths2.forEach(myFunction);

      function myFunction(item) {
        console.log(item[0].location);

        console.log(item[0].total_cases);
      }
*/
//let topo = loadData[0]

let mouseOver = function(d) {
d3.selectAll(".Country")
  .transition()
  .duration(200)
  .style("opacity", .5)
d3.select(this)
  .transition()
  .duration(200)
  .style("opacity", 1)
  .style("stroke", "black")
}

let mouseLeave = function(d) {
d3.selectAll(".Country")
  .transition()
  .duration(200)
  .style("opacity", .8)
d3.select(this)
  .transition()
  .duration(200)
  .style("stroke", "transparent")
}

// Draw the map
svg.append("g")
.selectAll("path")
.data(topo.features)
.enter()
.append("path")
  // draw each country
  .attr("d", d3.geoPath()
    .projection(projection)
  )
  // set the color of each country
  .attr("fill", function (d) {
    //console.log(nestedData.get(date).get(d.id))

    d.total = test2(d) || 0;
    return colorScale(d.total);
  })
  .style("stroke", "transparent")
  .attr("class", function(d){ return "Country" } )
  .style("opacity", .8)
  .on("mouseover", mouseOver )
  .on("mouseleave", mouseLeave )

})
})
  
function test2(d){

  try {
    test = nestedData.get("2022-06-01").get(d.id)[0].total_cases
    

}
catch(err) {
  return 0

}

return test
}
    </script>